var UITree = function () {
    var a = function () {
        $("#menu_tree").jstree({
            core: {
                themes: {responsive: !1}, check_callback: !0, data: {
                    url: function (e) {
                        return "/backend/menu/nodes"
                    }, data: function (e) {
                        return {parent: e.id, menu_id: menu_id}
                    }
                }
            },
            types: {
                "default": {icon: "fa fa-folder icon-state-warning icon-lg"},
                file: {icon: "fa fa-file icon-state-warning icon-lg"}
            },
            state: {key: "demo3"},
            plugins: ["contextmenu","dnd", "state", "types", "html_data"],
            "contextmenu": {
                "items": function ($node) {
                    return {
                        "Create": {
                            "label": "Create new child item",
                            "action": function (data) {
                                var ref = $.jstree.reference(data.reference);
                                sel = ref.get_selected();
                                if(!sel.length) { return false; }
                                sel = sel[0];
                                sel = ref.create_node(sel, {"type":"file"});
                                if(sel) {
                                    ref.edit(sel);
                                }

                            }
                        },
                        "Edit": {
                            "label": "Edit item",
                            "action": function (data) {
                                var ref = $.jstree.reference(data.reference);
                                sel = ref.get_selected();
                                if(!sel.length) { return false; }
                                sel = sel[0];
                                if(sel) {
                                    window.location = '/backend/menuitems/update/'+checkNewId(sel);
                                }

                            }
                        },
                        "Rename": {
                            "label": "Rename item",
                            "action": function (data) {
                                var inst = $.jstree.reference(data.reference);
                                obj = inst.get_node(data.reference);
                                inst.edit(obj);
                            }
                        },
                        "Delete": {
                            "label": "Delete item",
                            "action": function (data) {
                                var ref = $.jstree.reference(data.reference),
                                    sel = ref.get_selected();
                                if(!sel.length) { return false; }
                                ref.delete_node(sel);

                            }
                        }
                    };
                }
            }
        })
    };
    return {
        init: function () {
            a()
        }
    }
}();
App.isAngularJsApp() === !1 && jQuery(document).ready(function () {
    UITree.init()
});

$(document).ready(function(){

    $('#menu_tree').on("rename_node.jstree", function (e, data) {
        rename_menu_node( data );
    });

    $('#menu_tree').on("delete_node.jstree", function (e, data) {
        delete_menu_node( data );
    });

    $('#menu_tree').on("create_node.jstree", function (e, data) {
        create_menu_node( data );
    });

    $('#menu_tree').on("move_node.jstree", function (e, data) {
        move_menu_node( data );
    });

});

var menu_item_id_replace = new Array();

function create_menu_node( data ){

    formdata = 'parent_id='+checkNewId(data.parent)+'&position='+data.position+'&menu_id='+menu_id+'&name='+data.node.text;

    $.ajax({
        type: 'POST',
        url: '/backend/menu/createitem/',
        data: formdata,
        dataType: 'json',
        success: function(response){

            menu_item_id_replace[ data.node.id ] = response['id'];

        }
    });

}

function move_menu_node( data ){

    formdata = 'node_id='+checkNewId(data.node.id)+'&position='+data.position+'&parent_id='+data.parent+'&old_position='+data.old_position+'&menu_id='+menu_id;

    $.ajax({
        type: 'POST',
        url: '/backend/menu/moveitem/',
        data: formdata,
        dataType: 'json',
        success: function(response){}
    });

}

function rename_menu_node( data ){

    formdata = 'node_id='+checkNewId(data.node.id)+'&name='+data.text;

    $.ajax({
        type: 'POST',
        url: '/backend/menu/renameitem/',
        data: formdata,
        dataType: 'json',
        success: function(response){ }
    });

}

function delete_menu_node( data ){

    formdata = 'node_id='+checkNewId(data.node.id);

    $.ajax({
        type: 'POST',
        url: '/backend/menu/deleteitem/',
        data: formdata,
        dataType: 'json',
        success: function(response){ }
    });

}

function checkNewId( id ){

    if ( typeof menu_item_id_replace[ id ] != 'undefined' )
        return menu_item_id_replace[ id ];
    else
        return id;

}